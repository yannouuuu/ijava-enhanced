name: iJava Toolkit - DÃ©tection Intelligente des Mises Ã  Jour

on:
  workflow_dispatch:
    inputs:
      discordWebhook:
        description: "Webhook Discord (optionnel)"
        required: false
        type: string
  schedule:
    # VÃ©rification toutes les heures
    - cron: "0 * * * *"

permissions:
  contents: write

env:
  JAR_URL: https://www.iut-info.univ-lille.fr/~yann.secq/ijava/ijava.jar
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DATASET_DIR: datasets/ijava
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  check-and-publish:
    name: VÃ©rification intelligente et publication
    runs-on: ubuntu-latest

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¦ PHASE 1: PrÃ©paration de l'environnement
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ğŸ“¥ RÃ©cupÃ©ration du dÃ©pÃ´t
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—‚ï¸ CrÃ©ation des dossiers de travail
        run: |
          set -euo pipefail
          mkdir -p workspace/remote workspace/reference artifacts
          echo "âœ“ Dossiers de travail crÃ©Ã©s"

      - name: ğŸ”§ Installation des outils systÃ¨me
        run: |
          set -euo pipefail
          echo "Installation des dÃ©pendances..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget git jq default-jre-headless
          echo "âœ“ Outils systÃ¨me installÃ©s"

      - name: ğŸ”¨ Installation de JADX (dÃ©compilateur)
        run: |
          set -euo pipefail
          JADX_VERSION="1.5.0"
          JADX_URL="https://github.com/skylot/jadx/releases/download/v${JADX_VERSION}/jadx-${JADX_VERSION}.zip"
          
          echo "TÃ©lÃ©chargement de JADX v${JADX_VERSION}..."
          wget -q "$JADX_URL" -O /tmp/jadx.zip
          
          echo "Installation de JADX..."
          unzip -q /tmp/jadx.zip -d /tmp/jadx
          sudo rm -rf /opt/jadx
          sudo mv /tmp/jadx /opt/jadx
          sudo ln -sf /opt/jadx/bin/jadx /usr/local/bin/jadx
          sudo chmod +x /opt/jadx/bin/jadx
          
          echo "âœ“ JADX installÃ©:"
          /usr/local/bin/jadx --version

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸŒ PHASE 2: RÃ©cupÃ©ration du JAR distant
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸŒ TÃ©lÃ©chargement du JAR distant
        id: download
        run: |
          set -euo pipefail
          echo "TÃ©lÃ©chargement depuis $JAR_URL..."
          
          if curl --fail --location --retry 3 --retry-delay 5 \
               "$JAR_URL" --output workspace/remote/ijava.jar; then
            remote_sha=$(sha256sum workspace/remote/ijava.jar | awk '{print $1}')
            remote_size=$(stat -f%z workspace/remote/ijava.jar 2>/dev/null || stat -c%s workspace/remote/ijava.jar)
            
            echo "sha=$remote_sha" >> "$GITHUB_OUTPUT"
            echo "size=$remote_size" >> "$GITHUB_OUTPUT"
            echo "path=workspace/remote/ijava.jar" >> "$GITHUB_OUTPUT"
            
            echo "âœ“ TÃ©lÃ©chargement rÃ©ussi"
            echo "  ğŸ“Š Taille: ${remote_size} octets"
            echo "  ğŸ” SHA256: ${remote_sha}"
          else
            echo "âœ— Ã‰chec du tÃ©lÃ©chargement"
            exit 1
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“š PHASE 3: RÃ©cupÃ©ration de la version de rÃ©fÃ©rence
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“š RÃ©cupÃ©ration de la derniÃ¨re version connue
        id: reference
        run: |
          set -euo pipefail
          echo "Recherche de la derniÃ¨re release..."
          
          # Tentative de rÃ©cupÃ©ration via GitHub Release
          if gh release view --json tagName,assets > /tmp/release.json 2>/tmp/release.err; then
            tag=$(jq -r '.tagName' /tmp/release.json)
            asset_exists=$(jq '[.assets[] | select(.name=="ijava.jar")] | length' /tmp/release.json)
            
            if [ "$asset_exists" -gt 0 ]; then
              echo "found=release" >> "$GITHUB_OUTPUT"
              echo "tag=$tag" >> "$GITHUB_OUTPUT"
              
              # TÃ©lÃ©chargement du JAR de rÃ©fÃ©rence
              if gh release download "$tag" --pattern "ijava.jar" \
                   --dir workspace/reference --clobber 2>&1; then
                ref_sha=$(sha256sum workspace/reference/ijava.jar | awk '{print $1}')
                echo "sha=$ref_sha" >> "$GITHUB_OUTPUT"
                echo "âœ“ Version de rÃ©fÃ©rence: $tag"
                echo "  ğŸ” SHA256: $ref_sha"
                exit 0
              fi
            fi
          fi
          
          # Plan B: chercher dans le dataset local
          echo "Aucune release trouvÃ©e, recherche dans le dataset local..."
          latest_local=$(find "$DATASET_DIR" -maxdepth 1 -type d -name "ijava-*" | sort -r | head -n 1)
          
          if [ -n "$latest_local" ] && [ -f "$latest_local/ijava.jar" ]; then
            cp "$latest_local/ijava.jar" workspace/reference/ijava.jar
            ref_sha=$(sha256sum workspace/reference/ijava.jar | awk '{print $1}')
            
            echo "found=local" >> "$GITHUB_OUTPUT"
            echo "tag=$(basename "$latest_local")" >> "$GITHUB_OUTPUT"
            echo "sha=$ref_sha" >> "$GITHUB_OUTPUT"
            echo "âœ“ Version de rÃ©fÃ©rence locale: $(basename "$latest_local")"
            echo "  ğŸ” SHA256: $ref_sha"
          else
            echo "found=none" >> "$GITHUB_OUTPUT"
            echo "âš  Aucune version de rÃ©fÃ©rence trouvÃ©e"
            echo "  â†’ PremiÃ¨re exÃ©cution, toute version sera considÃ©rÃ©e comme nouvelle"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PHASE 4: Comparaison
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ” Analyse comparative des fichiers .class
        id: compare
        run: |
          set -euo pipefail
          
          reference_found="${{ steps.reference.outputs.found }}"
          
          # Si aucune rÃ©fÃ©rence, c'est forcÃ©ment une nouvelle version
          if [ "$reference_found" = "none" ]; then
            echo "update=true" >> "$GITHUB_OUTPUT"
            echo "reason=PremiÃ¨re version dÃ©tectÃ©e" >> "$GITHUB_OUTPUT"
            echo "âœ“ Aucune version de rÃ©fÃ©rence â†’ mise Ã  jour requise"
            exit 0
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Comparaison approfondie des fichiers .class"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo
          
          # Comparaison avec notre script intelligent
          if ./scripts/diff_jars.sh \
               workspace/reference/ijava.jar \
               workspace/remote/ijava.jar; then
            
            echo "update=false" >> "$GITHUB_OUTPUT"
            echo "reason=Les fichiers .class sont identiques" >> "$GITHUB_OUTPUT"
            echo
            echo "âœ“ Aucune diffÃ©rence fonctionnelle dÃ©tectÃ©e"
            echo "  â†’ Pas de mise Ã  jour nÃ©cessaire"
          else
            echo "update=true" >> "$GITHUB_OUTPUT"
            echo "reason=DiffÃ©rences dÃ©tectÃ©es dans le code dÃ©compilÃ©" >> "$GITHUB_OUTPUT"
            echo
            echo "âœ“ Changements dÃ©tectÃ©s dans le code"
            echo "  â†’ Mise Ã  jour nÃ©cessaire"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ·ï¸ PHASE 5: PrÃ©paration de la nouvelle version
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ·ï¸ GÃ©nÃ©ration des mÃ©tadonnÃ©es de version
        id: metadata
        if: steps.compare.outputs.update == 'true'
        run: |
          set -euo pipefail
          
          # GÃ©nÃ©ration d'un tag basÃ© sur la date/heure UTC
          tag="ijava-$(date -u +"%Y%m%d-%H%M%S")"
          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          human_date=$(date -u +"%d %B %Y Ã  %H:%M:%S UTC")
          
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "timestamp=$timestamp" >> "$GITHUB_OUTPUT"
          echo "human_date=$human_date" >> "$GITHUB_OUTPUT"
          
          echo "âœ“ Nouvelle version prÃ©parÃ©e:"
          echo "  ğŸ·ï¸  Tag: $tag"
          echo "  ğŸ“… Date: $human_date"

      - name: ğŸ“ Mise Ã  jour du registre versions.json
        if: steps.compare.outputs.update == 'true'
        run: |
          set -euo pipefail
          
          # CrÃ©ation du fichier s'il n'existe pas
          if [ ! -f versions.json ]; then
            echo "[]" > versions.json
          fi
          
          # Ajout de la nouvelle version
          tmp=$(mktemp)
          dataset_path="$DATASET_DIR/${{ steps.metadata.outputs.tag }}/ijava.jar"
          
          jq --arg tag "${{ steps.metadata.outputs.tag }}" \
             --arg date "${{ steps.metadata.outputs.timestamp }}" \
             --arg sha "${{ steps.download.outputs.sha }}" \
             --arg path "$dataset_path" \
             --arg reason "${{ steps.compare.outputs.reason }}" \
             '. + [{
                "version": $tag,
                "date": $date,
                "sha256": $sha,
                "path": $path,
                "reason": $reason
              }]' versions.json > "$tmp"
          
          mv "$tmp" versions.json
          
          echo "âœ“ versions.json mis Ã  jour"
          echo "  ğŸ“Š Nombre de versions: $(jq 'length' versions.json)"

      - name: ğŸ’¾ Archivage du JAR dans le dataset
        if: steps.compare.outputs.update == 'true'
        env:
          TAG: ${{ steps.metadata.outputs.tag }}
        run: |
          set -euo pipefail
          
          target_dir="$DATASET_DIR/$TAG"
          mkdir -p "$target_dir"
          
          # Copie du JAR et gÃ©nÃ©ration du checksum
          cp workspace/remote/ijava.jar "$target_dir/ijava.jar"
          sha256sum "$target_dir/ijava.jar" | awk '{print $1}' > "$target_dir/ijava.jar.sha256"
          
          echo "âœ“ JAR archivÃ© dans: $target_dir"
          ls -lh "$target_dir"

      - name: ğŸ”“ DÃ©compilation pour archivage
        if: steps.compare.outputs.update == 'true'
        env:
          TAG: ${{ steps.metadata.outputs.tag }}
        run: |
          set -euo pipefail
          
          echo "DÃ©compilation du JAR pour archivage..."
          ./scripts/process_ijava.sh --dataset-dir "$DATASET_DIR" --force
          
          echo "âœ“ DÃ©compilation terminÃ©e"
          echo "  ğŸ“‚ Structure crÃ©Ã©e:"
          ls -lh "$DATASET_DIR/$TAG"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¤ PHASE 6: Publication
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“¤ Commit et push des changements
        if: steps.compare.outputs.update == 'true'
        env:
          TAG: ${{ steps.metadata.outputs.tag }}
        run: |
          set -euo pipefail
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add versions.json "$DATASET_DIR"
          
          if git diff --cached --quiet; then
            echo "âš  Aucun changement Ã  committer"
          else
            git commit -m "chore: nouvelle version $TAG

          Cette version a Ã©tÃ© dÃ©tectÃ©e automatiquement par comparaison
          des fichiers .class dÃ©compilÃ©s.

          Raison: ${{ steps.compare.outputs.reason }}"
                      
            git push
            echo "âœ“ Changements poussÃ©s vers le dÃ©pÃ´t"
          fi

      - name: ğŸ‰ CrÃ©ation de la release GitHub
        if: steps.compare.outputs.update == 'true'
        env:
          TAG: ${{ steps.metadata.outputs.tag }}
          SHA: ${{ steps.download.outputs.sha }}
          HUMAN_DATE: ${{ steps.metadata.outputs.human_date }}
          REASON: ${{ steps.compare.outputs.reason }}
        run: |
          set -euo pipefail
          
          notes_file=$(mktemp)
          {
            echo "# ğŸ“ Nouvelle version iJava dÃ©tectÃ©e"
            echo
            echo "Cette version a Ã©tÃ© automatiquement dÃ©tectÃ©e et publiÃ©e par analyse"
            echo "du contenu dÃ©compilÃ© des fichiers \`.class\`."
            echo
            echo "## ğŸ“Š Informations"
            echo
            echo "- **Date de dÃ©tection**: $HUMAN_DATE"
            echo "- **SHA256**: \`$SHA\`"
            echo "- **Raison**: $REASON"
            echo
            echo "## ğŸ”— Source"
            echo
            echo "Le JAR a Ã©tÃ© rÃ©cupÃ©rÃ© depuis: $JAR_URL"
            echo
            echo "---"
            echo
            echo "_Cette release a Ã©tÃ© crÃ©Ã©e automatiquement par GitHub Actions._"
          } > "$notes_file"
          
          gh release create "$TAG" \
            "$DATASET_DIR/$TAG/ijava.jar" \
            --title "ğŸ“ iJava $TAG" \
            --notes-file "$notes_file"
          
          echo "âœ“ Release $TAG crÃ©Ã©e avec succÃ¨s"

      - name: ğŸ“¢ Notification Discord
        if: steps.compare.outputs.update == 'true'
        env:
          DISCORD_WEBHOOK_INPUT: ${{ github.event.inputs.discordWebhook }}
          DISCORD_WEBHOOK_SECRET: ${{ env.DISCORD_WEBHOOK_URL }}
          TAG: ${{ steps.metadata.outputs.tag }}
          REASON: ${{ steps.compare.outputs.reason }}
        run: |
          set -euo pipefail
          
          webhook="${DISCORD_WEBHOOK_INPUT:-${DISCORD_WEBHOOK_SECRET:-}}"
          
          if [ -z "$webhook" ]; then
            echo "âš  Webhook Discord non configurÃ©, notification ignorÃ©e"
            exit 0
          fi
          
          payload=$(jq -n \
            --arg content "ğŸ“ **Nouvelle version iJava dÃ©tectÃ©e !**

          **Version**: \`$TAG\`
          **Raison**: $REASON

          Une nouvelle release est disponible sur GitHub." \
            '{content: $content}')
          
          if curl -X POST -H "Content-Type: application/json" \
               -d "$payload" "$webhook" --fail; then
            echo "âœ“ Notification Discord envoyÃ©e"
          else
            echo "âš  Ã‰chec de l'envoi de la notification Discord"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“‹ PHASE 7: RÃ©capitulatif
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“‹ RÃ©capitulatif de l'exÃ©cution
        if: always()
        run: |
          set -euo pipefail
          
          echo
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ“‹ RÃ©capitulatif de l'exÃ©cution"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo
          
          if [ "${{ steps.compare.outputs.update }}" = "true" ]; then
            echo "âœ… Nouvelle version publiÃ©e avec succÃ¨s"
            echo
            echo "  ğŸ·ï¸  Tag: ${{ steps.metadata.outputs.tag }}"
            echo "  ğŸ“… Date: ${{ steps.metadata.outputs.human_date }}"
            echo "  ğŸ’¡ Raison: ${{ steps.compare.outputs.reason }}"
            echo
            echo "La nouvelle version est disponible sur GitHub Releases."
          else
            echo "â„¹ï¸  Aucune mise Ã  jour nÃ©cessaire"
            echo
            echo "  Le JAR distant est identique Ã  la derniÃ¨re version connue."
            echo "  Aucun changement fonctionnel dÃ©tectÃ© dans les fichiers .class."
          fi
          
          echo
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
